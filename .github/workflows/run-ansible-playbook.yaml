name: Reusable - Run Ansible Playbook with Cloud OIDC

on:
  workflow_call:
    inputs:
      cloud-provider:
        description: "Target cloud provider (aws, gcp, azure)"
        required: true
        type: string
      release-tag:
        description: "Git release tag to check out. If omitted, the latest commit on the default branch is used."
        required: false
        type: string
        default: ""
      python-version:
        description: "Python version for installing ansible"
        required: false
        type: string
        default: "3.12"
      ansible-extra-vars:
        description: "Extra variables to pass to the Ansible playbook"
        required: false
        type: string
      ansible-playbook-path:
        description: "Path to the Ansible playbook file"
        required: true
        type: string
      # AWS Authentication Inputs
      aws-region:
        description: "AWS region for authentication. Required when cloud-provider is 'aws'."
        required: false
        type: string
    secrets:
      # AWS Authentication Secret
      aws-role-to-assume:
        description: "AWS IAM role ARN to assume. Required when cloud-provider is 'aws'."
        required: false
      # GCP Authentication Secrets
      gcp-wif-provider:
        description: "GCP Workload Identity Federation provider. Required when cloud-provider is 'gcp'."
        required: false
      gcp-service-account:
        description: "GCP service account email for authentication. Required when cloud-provider is 'gcp'."
        required: false
      # Azure Authentication Secrets
      azure-client-id:
        description: "Azure client ID for authentication. Required when cloud-provider is 'azure'."
        required: false
      azure-tenant-id:
        description: "Azure tenant ID for authentication. Required when cloud-provider is 'azure'."
        required: false
      azure-subscription-id:
        description: "Azure subscription ID for authentication. Required when cloud-provider is 'azure'."
        required: false

permissions:
  id-token: write
  contents: read

jobs:
  run-playbook:
    runs-on: ubuntu-latest
    steps:
      - name: Set Execution Timestamp
        id: timestamp
        run: |
          echo "execution_time=$(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> $GITHUB_OUTPUT
          echo "execution_epoch=$(date +%s)" >> $GITHUB_OUTPUT

      - name: Print Inputs
        run: |
          echo "=== Workflow Inputs ==="
          echo "Cloud Provider: ${{ inputs.cloud-provider }}"
          echo "Python Version: ${{ inputs.python-version }}"
          echo "Ansible Extra Vars: ${{ inputs.ansible-extra-vars }}"
          echo "Ansible Playbook Path: ${{ inputs.ansible-playbook-path }}"
          echo "AWS Region: ${{ inputs.aws-region }}"
          echo "AWS Role to Assume: ${{ secrets.aws-role-to-assume && '[PROVIDED]' || '[NOT PROVIDED]' }}"
          echo "GCP WIF Provider: ${{ secrets.gcp-wif-provider && '[PROVIDED]' || '[NOT PROVIDED]' }}"
          echo "GCP Service Account: ${{ secrets.gcp-service-account && '[PROVIDED]' || '[NOT PROVIDED]' }}"
          echo "Azure Client ID: ${{ secrets.azure-client-id && '[PROVIDED]' || '[NOT PROVIDED]' }}"
          echo "Azure Tenant ID: ${{ secrets.azure-tenant-id && '[PROVIDED]' || '[NOT PROVIDED]' }}"
          echo "Azure Subscription ID: ${{ secrets.azure-subscription-id && '[PROVIDED]' || '[NOT PROVIDED]' }}"
          echo "======================="

      - name: Validate Cloud Provider
        run: |
          if [[ "${{ inputs.cloud-provider }}" != "aws" && "${{ inputs.cloud-provider }}" != "gcp" && "${{ inputs.cloud-provider }}" != "azure" ]]; then
            echo "Error: Invalid cloud provider '${{ inputs.cloud-provider }}'. Must be one of: aws, gcp, azure"
            exit 1
          fi
          echo "Valid cloud provider: ${{ inputs.cloud-provider }}"

      # Determine checkout reference
      #############################################
      - name: Set Checkout Ref
        id: set-ref
        shell: bash
        run: |
          if [[ -n "${{ inputs.release-tag }}" ]]; then
            echo "ref=${{ inputs.release-tag }}" >> $GITHUB_OUTPUT
          else
            echo "ref=${GITHUB_REF_NAME}" >> $GITHUB_OUTPUT
          fi

      # Checkout repo and setup Terraform
      #############################################
      - name: Checkout Repo
        id: checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ steps.set-ref.outputs.ref }}

      - name: Validate Ansible Playbook Path
        run: |
          if [[ ! -f "${{ inputs.ansible-playbook-path }}" ]]; then
            echo "Error: Ansible playbook file '${{ inputs.ansible-playbook-path }}' does not exist"
            exit 1
          fi
          echo "Valid playbook file: ${{ inputs.ansible-playbook-path }}"

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ inputs.python-version }}

      - name: Install Ansible
        run: |
          python -m pip install --upgrade pip
          pip install ansible

      # -------------------------
      # Ensure Cloud CLIs are installed
      # -------------------------
      # AWS CLI (install if missing)
      - name: AWS | Ensure AWS CLI exists
        if: ${{ inputs.cloud-provider == 'aws' }}
        shell: bash
        run: |
          set -euo pipefail
          if command -v aws >/dev/null 2>&1; then
            aws --version
          else
            curl -sS "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o awscliv2.zip
            unzip -q awscliv2.zip
            sudo ./aws/install
            aws --version
          fi

      # Azure CLI (install if missing)
      - name: Azure | Ensure Azure CLI exists
        if: ${{ inputs.cloud-provider == 'azure' }}
        shell: bash
        run: |
          set -euo pipefail
          if command -v az >/dev/null 2>&1; then
            az version
          else
            curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
            az version
          fi

      # -------------------------
      # AWS OIDC setup
      # -------------------------
      - name: AWS | Configure credentials via OIDC
        if: ${{ inputs.cloud-provider == 'aws' }}
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ secrets.aws-role-to-assume }}
          aws-region: ${{ inputs.aws-region }}

      # -------------------------
      # Azure OIDC setup
      # -------------------------
      - name: Azure | Get federated token for az login
        if: ${{ inputs.cloud-provider == 'azure' }}
        shell: bash
        run: |
          set -euo pipefail
          TOKEN="$(curl -sSL \
            -H "Authorization: bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" \
            "${ACTIONS_ID_TOKEN_REQUEST_URL}&audience=api://AzureADTokenExchange" | \
            python -c "import sys, json; print(json.load(sys.stdin)['value'])")"
          echo "AZURE_FEDERATED_TOKEN=$TOKEN" >> "$GITHUB_ENV"

      - name: Debug GitHub OIDC claims
        if: ${{ inputs.cloud-provider == 'azure' }}
        shell: bash
        run: |
          TOKEN_JSON=$(curl -sSf -H "Authorization: Bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" \
            "${ACTIONS_ID_TOKEN_REQUEST_URL}&audience=api://AzureADTokenExchange")
          TOKEN=$(echo "$TOKEN_JSON" | python -c 'import sys,json; print(json.load(sys.stdin)["value"])')
          PAYLOAD=$(echo "$TOKEN" | cut -d'.' -f2 | tr '_-' '/+' | awk '{print $0"=="}' | base64 -d 2>/dev/null || true)
          echo "$PAYLOAD"

      - name: Debug Azure IDs (actual values)
        if: ${{ inputs.cloud-provider == 'azure' }}
        run: |
          echo "AZURE_CLIENT_ID=${{ secrets.azure-client-id }}"
          echo "AZURE_TENANT_ID=${{ secrets.azure-tenant-id }}"
          echo "AZURE_SUBSCRIPTION_ID=${{ secrets.azure-subscription-id }}"

      - name: Azure | Login with OIDC
        if: ${{ inputs.cloud-provider == 'azure' }}
        shell: bash
        run: |
          set -euo pipefail
          az login \
            --service-principal \
            --username "${{ secrets.azure-client-id }}" \
            --tenant "${{ secrets.azure-tenant-id }}" \
            --federated-token "$AZURE_FEDERATED_TOKEN"
          az account set --subscription "${{ secrets.azure-subscription-id }}"

      # -------------------------
      # GCP OIDC setup
      # -------------------------
      - name: GCP | Auth via Workload Identity Federation
        if: ${{ inputs.cloud-provider == 'gcp' }}
        uses: google-github-actions/auth@v3
        with:
          workload_identity_provider: ${{ secrets.gcp-wif-provider }}
          service_account: ${{ secrets.gcp-service-account }}

      - name: GCP | Setup gcloud
        if: ${{ inputs.cloud-provider == 'gcp' }}
        uses: google-github-actions/setup-gcloud@v3

      # -------------------------
      # Run Ansible Playbook
      # -------------------------
      - name: Parse and Display Extra Variables
        if: inputs.ansible-extra-vars != ''
        run: |
          echo "=========================================="
          echo "Parsing Ansible Extra Variables"
          echo "=========================================="
          
          # Create temporary file for JSON processing
          EXTRA_VARS_FILE=$(mktemp)
          echo '${{ inputs.ansible-extra-vars }}' > "$EXTRA_VARS_FILE"
          
          # Validate and parse JSON
          if python3 -m json.tool "$EXTRA_VARS_FILE" > /dev/null 2>&1; then
            echo "âœ… JSON syntax is valid"
            
            # Create GitHub Step Summary with table
            cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## ðŸ“‹ Ansible Extra Variables Summary
          
          ### ðŸ”§ Deployment Configuration
          | Key | Value |
          |-----|-------|
          EOF
            
            # Parse and display deployment variables using a different approach
            python3 -c "
          import json
          import sys
          
          # Read the JSON file
          with open('$EXTRA_VARS_FILE', 'r') as f:
              data = json.load(f)
          
          def print_all_vars(obj):
              for key, value in obj.items():
                  if isinstance(value, dict):
                      # Handle nested objects
                      for nested_key, nested_value in value.items():
                          display_value = str(nested_value) if nested_value != '' else '*Not specified*'
                          print(f'| \`{nested_key}\` | {display_value} |')
                  else:
                      # Handle flat key-value pairs
                      display_value = str(value) if value != '' else '*Not specified*'
                      print(f'| \`{key}\` | {display_value} |')
          
          print_all_vars(data)
          " >> $GITHUB_STEP_SUMMARY
            
            cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          
          ---
          EOF
            
            # Also display in console with colors
            echo ""
            echo "ðŸ“‹ Parsed Variables:"
            echo "===================="
            python3 -c "
          import json
          
          with open('$EXTRA_VARS_FILE', 'r') as f:
              data = json.load(f)
          
          def print_vars(obj, indent=0):
              for key, value in obj.items():
                  if isinstance(value, dict):
                      print('  ' * indent + f'ðŸ“ {key}:')
                      print_vars(value, indent + 1)
                  else:
                      display_value = str(value) if value != '' else 'âš ï¸  Not specified'
                      print('  ' * indent + f'ðŸ”¹ {key}: {display_value}')
          
          print_vars(data)
          "
            
          else
            echo "âŒ Invalid JSON syntax in extra variables"
            echo "Please check your JSON format in the caller workflow."
            
            # Add error to summary
            cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## âŒ Ansible Extra Variables Error
          
          **Invalid JSON syntax detected in extra variables.**
          
          Please check your JSON format in the caller workflow and ensure:
          - No trailing commas
          - Proper quote escaping
          - Valid JSON structure
          
          ---
          EOF
          fi
          
          # Clean up
          rm -f "$EXTRA_VARS_FILE"
          echo "=========================================="

      - name: Run playbook
        id: ansible-execution
        run: |
          echo "=========================================="
          echo "Starting Ansible Playbook Execution"
          echo "=========================================="
          echo "Playbook: ${{ inputs.ansible-playbook-path }}"
          echo "Extra Variables: ${{ inputs.ansible-extra-vars }}"
          echo "=========================================="
          
          # Create temporary files to capture output
          OUTPUT_FILE=$(mktemp)
          ERROR_FILE=$(mktemp)
          EXTRA_VARS_FILE=$(mktemp)
          
          # Handle extra variables
          if [ -n "${{ inputs.ansible-extra-vars }}" ]; then
            EXTRA_VARS='${{ inputs.ansible-extra-vars }}'
            
            # Check if it's a JSON object (starts with { and ends with })
            if [[ "$EXTRA_VARS" =~ ^[[:space:]]*\{.*\}[[:space:]]*$ ]]; then
              echo "Detected JSON format for extra variables"
              echo "Validating JSON syntax..."
              
              # Write JSON to temporary file for validation
              echo "$EXTRA_VARS" > "$EXTRA_VARS_FILE"
              
              # Validate JSON syntax
              if python3 -m json.tool "$EXTRA_VARS_FILE" > /dev/null 2>&1; then
                echo "âœ… JSON syntax is valid"
                echo "Contents of extra vars file:"
                cat "$EXTRA_VARS_FILE"
                echo ""
                echo "Running playbook with JSON extra variables..."
                
                # Run ansible-playbook and capture output in real-time
                set +e  # Don't exit on error
                ansible-playbook "${{ inputs.ansible-playbook-path }}" \
                  --extra-vars "@$EXTRA_VARS_FILE" \
                  -v 2>&1 | tee "$OUTPUT_FILE"
                ANSIBLE_EXIT_CODE=${PIPESTATUS[0]}
                set -e  # Re-enable exit on error
                
              else
                echo "âŒ Invalid JSON syntax in extra variables"
                echo "JSON validation failed. Please check your JSON format."
                python3 -m json.tool "$EXTRA_VARS_FILE" 2>&1 || true
                exit 1
              fi
            else
              echo "Detected key=value or YAML format for extra variables"
              echo "Running playbook with string extra variables..."
              
              # Run ansible-playbook and capture output in real-time
              set +e  # Don't exit on error
              ansible-playbook "${{ inputs.ansible-playbook-path }}" \
                --extra-vars "$EXTRA_VARS" \
                -v 2>&1 | tee "$OUTPUT_FILE"
              ANSIBLE_EXIT_CODE=${PIPESTATUS[0]}
              set -e  # Re-enable exit on error
            fi
          else
            echo "Running without extra variables..."
            
            # Run ansible-playbook and capture output in real-time
            set +e  # Don't exit on error
            ansible-playbook "${{ inputs.ansible-playbook-path }}" \
              -v 2>&1 | tee "$OUTPUT_FILE"
            ANSIBLE_EXIT_CODE=${PIPESTATUS[0]}
            set -e  # Re-enable exit on error
          fi
          
          echo "=========================================="
          echo "Ansible Playbook Execution Complete"
          echo "Exit Code: $ANSIBLE_EXIT_CODE"
          echo "=========================================="
          
          # Set step outputs
          {
            echo "stdout<<EOF"
            cat "$OUTPUT_FILE"
            echo "EOF"
          } >> $GITHUB_OUTPUT
          
          {
            echo "stderr<<EOF"
            # Since we're using tee, errors are also in OUTPUT_FILE
            if [ $ANSIBLE_EXIT_CODE -ne 0 ]; then
              echo "Ansible execution failed with exit code $ANSIBLE_EXIT_CODE"
              echo "Full output:"
              cat "$OUTPUT_FILE"
            fi
            echo "EOF"
          } >> $GITHUB_OUTPUT
          
          echo "exit_code=$ANSIBLE_EXIT_CODE" >> $GITHUB_OUTPUT
          
          if [ $ANSIBLE_EXIT_CODE -eq 0 ]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "âœ… Playbook executed successfully!"
          else
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "âŒ Playbook execution failed!"
            echo "Full output was displayed above."
          fi
          
          # Clean up temporary files
          rm -f "$OUTPUT_FILE" "$ERROR_FILE" "$EXTRA_VARS_FILE"
          
          # Exit with the original code
          exit $ANSIBLE_EXIT_CODE

      - name: Display Ansible Results
        if: always()
        run: |
          echo "=========================================="
          echo "Ansible Execution Summary"
          echo "=========================================="
          echo "Status: ${{ steps.ansible-execution.outputs.status }}"
          echo "Exit Code: ${{ steps.ansible-execution.outputs.exit_code }}"
          echo "=========================================="
          
          # Add execution summary to GitHub Step Summary
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## ðŸŽ¯ Ansible Playbook Execution Results
          
          | Metric | Value |
          |--------|-------|
          | **Status** | ${{ steps.ansible-execution.outputs.status == 'success' && 'âœ… Success' || 'âŒ Failed' }} |
          | **Exit Code** | `${{ steps.ansible-execution.outputs.exit_code }}` |
          | **Playbook Path** | `${{ inputs.ansible-playbook-path }}` |
          | **Cloud Provider** | `${{ inputs.cloud-provider }}` |
          | **Python Version** | `${{ inputs.python-version }}` |
          | **Execution Time** | `${{ steps.timestamp.outputs.execution_time }}` |
          | **Triggered By** | `${{ github.actor }}` |
          | **Git Reference** | `${{ github.ref_name }}` |
          
          EOF
          
          # Add output details if there are any
          if [ "${{ steps.ansible-execution.outputs.status }}" = "failed" ]; then
            cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ### âŒ Error Details
          
          ```
          ${{ steps.ansible-execution.outputs.stderr }}
          ```
          
          EOF
          fi
          
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ---
          *Generated by run-ansible-playbook workflow*
          EOF